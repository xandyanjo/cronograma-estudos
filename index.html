<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ğŸ“š Cronograma de Estudos</title>
<!-- Firebase ANTES do React -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<script>
  try {
    firebase.initializeApp({
      apiKey: "AIzaSyBR3MoezjKyBdnasY9asVqdxD3nMtoS44Q",
      authDomain: "cronogram-de-estudos.firebaseapp.com",
      databaseURL: "https://cronograma-de-estudos-default-rtdb.firebaseio.com",
      projectId: "cronogram-de-estudos",
      storageBucket: "cronogram-de-estudos.firebasestorage.app",
      messagingSenderId: "742013544348",
      appId: "1:742013544348:web:e27311a9b16a18a9ca4a59"
    });
    window.db   = firebase.database();
    window.auth = firebase.auth();
  } catch(e) { window.db = null; window.auth = null; }
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.development.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet"/>
<style>
  *{box-sizing:border-box;}
  body{background:#0f172a;margin:0;font-family:system-ui,sans-serif;}
  ::-webkit-scrollbar{width:4px;}
  ::-webkit-scrollbar-track{background:transparent;}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.15);border-radius:4px;}
  input[type=range]{accent-color:#60a5fa;width:100%;}
  @keyframes slideIn{from{opacity:0;transform:translateY(-8px);}to{opacity:1;transform:translateY(0);}}
  @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
  .slide-in{animation:slideIn .2s ease;}
  .pulse{animation:pulse 2s infinite;}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useReducer,useMemo,useCallback,useRef}=React;

// â”€â”€â”€ CONSTANTES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const STREAK_MIN=300,HEATMAP_DIAS=84,TOAST_MS=5000,DATA_PROVA_PAD='2025-05-15';
const LS={T:'tempos_estudo',C:'concluidos_estudo',TC:'topicos_completos',TP:'topicos_personalizados',
  R:'resumos_topicos',RD:'registros_diarios',D:'diarios_semanais',TR:'topicos_revisar',
  B:'badges_ganhos',PR:'pomodoro_rodadas',RN:'topicos_renomeados',DP:'data_prova'};

// â”€â”€â”€ DADOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CONTEUDOS={
  historia:{nome:'HistÃ³ria Militar Naval',categorias:[
    {titulo:'1. Antiguidade',topicos:['Egito Antigo e FenÃ­cia','GrÃ©cia Antiga','Batalha Naval de Salamina','Guerra do Peloponeso','Alexandre, o Grande','Roma x Cartago','Batalha de Mylae','Guerras Civis Romanas','Mare Nostrum']},
    {titulo:'2. Idade MÃ©dia',topicos:['CivilizaÃ§Ã£o x BarbÃ¡rie','ExpansÃ£o IslÃ¢mica (Sombra do Crescente)','Vikings','RepÃºblicas MarÃ­timas Italianas','Navio de Guerra Medieval','Guerra e ComÃ©rcio na Idade MÃ©dia','Batalha de Lepanto']},
    {titulo:'3. HistÃ³ria do Brasil 1 (PerÃ­odo Colonial)',topicos:['FormaÃ§Ã£o do Estado PortuguÃªs','Pioneirismo PortuguÃªs nas Grandes NavegaÃ§Ãµes','Chegada dos Portugueses ao Brasil','ExpediÃ§Ãµes Guarda-Costas','Martim Afonso de Souza','InvasÃµes Francesas (RJ e MA)','Invasores na Foz do Amazonas','Defesa do ImpÃ©rio MarÃ­timo PortuguÃªs (sÃ©c. XVI-XVIII)']},
    {titulo:'4. HistÃ³ria do Brasil 2 (Brasil ImpÃ©rio - FormaÃ§Ã£o)',topicos:['Vinda da FamÃ­lia Real','Conquista de Caiena','OcupaÃ§Ã£o da Banda Oriental','IndependÃªncia do Brasil','Guerra da IndependÃªncia','Marinha no Reinado de D. Pedro I','Guerra da Cisplatina','Revoltas Regenciais']},
    {titulo:'5. Idade Moderna (Europa e ExpansÃ£o MarÃ­tima)',topicos:['Espanha e o Mar','InvencÃ­vel Armada','Holanda e o Mar','Guerras Anglo-Holandesas','Inglaterra e FranÃ§a no cenÃ¡rio naval','Conflitos navais do sÃ©culo XVIII','Trafalgar','RevoluÃ§Ãµes do sÃ©culo XVIII']},
    {titulo:'6. HistÃ³ria do Brasil 3 (Segundo Reinado)',topicos:['Guerra contra Oribe e Rosas','Guerra da TrÃ­plice AlianÃ§a','Batalha Naval do Riachuelo','Marinha Imperial na Guerra do Paraguai','EvoluÃ§Ã£o tecnolÃ³gica naval (vela â†’ vapor / madeira â†’ aÃ§o)']},
    {titulo:'7. Mundo ContemporÃ¢neo',topicos:['Guerra da Crimeia','Guerra da SecessÃ£o','Guerras Imperialistas (Lissa, Franco-Prussiana)','Guerra Russo-Japonesa (Tsushima)','Primeira Guerra Mundial','Batalha da JutlÃ¢ndia','Segunda Guerra Mundial','Batalha do AtlÃ¢ntico','Midway','Golfo de Leyte']},
    {titulo:'8. HistÃ³ria do Brasil 4 (RepÃºblica Velha e Era Vargas)',topicos:['Marinha nas primeiras dÃ©cadas da RepÃºblica','Primeira Guerra e atuaÃ§Ã£o da Marinha do Brasil','Segunda Guerra Mundial e atuaÃ§Ã£o da Marinha','ConturbaÃ§Ãµes polÃ­ticas','ModernizaÃ§Ã£o naval']},
    {titulo:'9. HistÃ³ria Geral (EvoluÃ§Ã£o TecnolÃ³gica e EstratÃ©gia)',topicos:['EvoluÃ§Ã£o tecnolÃ³gica naval (sÃ©culos XIX-XX)','CouraÃ§a x CanhÃ£o','Dreadnought','Submarinos','AviaÃ§Ã£o Naval','Energia nuclear','EvoluÃ§Ã£o do pensamento estratÃ©gico naval']},
    {titulo:'10. HistÃ³ria do Brasil 5 (PÃ³s-1945)',topicos:['PolÃ­tica MarÃ­tima Brasileira no PÃ³s-Guerra','Programa de Reaparelhamento','Projeto Paralelo','PND e MD','AquisiÃ§Ã£o do NAE SÃ£o Paulo','Pensamento EstratÃ©gico Naval Brasileiro (1970-atualidade)','Emprego Permanente do Poder Naval']},
    {titulo:'11. Marinha do Brasil na Era Vargas',topicos:['ReorganizaÃ§Ã£o da Marinha','PolÃ­tica de reaparelhamento','Contexto estratÃ©gico do perÃ­odo','PreparaÃ§Ã£o para a Segunda Guerra Mundial']},
  ]},
  geografia:{nome:'Geografia EconÃ´mica',categorias:[
    {titulo:'ğŸŒ BASE CONCEITUAL (Fundamentos)',topicos:['Capitalismo','GlobalizaÃ§Ã£o','Desenvolvimento Humano','Geografia da PopulaÃ§Ã£o','QuestÃ£o Ambiental']},
    {titulo:'ğŸ­ PROCESSO DE INDUSTRIALIZAÃ‡ÃƒO (Mundo)',topicos:['PaÃ­ses Pioneiros no Processo de IndustrializaÃ§Ã£o','IndustrializaÃ§Ã£o Planificada na RÃºssia','IndustrializaÃ§Ã£o Planificada na China','PaÃ­ses de IndustrializaÃ§Ã£o Tardia','PaÃ­ses Recentemente Industrializados','Tigres AsiÃ¡ticos','IndÃºstrias 1','IndÃºstrias 2','IndÃºstrias 3','IndÃºstrias 4']},
    {titulo:'ğŸŒ ECONOMIA GLOBAL',topicos:['ComÃ©rcio Mundial e Blocos EconÃ´micos Regionais','Geografia e PolÃ­tica da Energia','Geografia da Energia e Transporte no Brasil']},
    {titulo:'ğŸŒ GEOPOLÃTICA MUNDIAL',topicos:['PÃ³s-Guerra e Guerra Fria','Oriente MÃ©dio','Ãfrica','RegiÃµes Polares','AustrÃ¡lia e Nova ZelÃ¢ndia']},
    {titulo:'ğŸ‡§ğŸ‡· BRASIL',topicos:['ProduÃ§Ã£o do TerritÃ³rio Brasileiro','IndustrializaÃ§Ã£o Brasileira','Geografia Urbana','Geografia AgrÃ¡ria','PolÃ­tica Ambiental Brasileira (SNUC)','AmazÃ´nia','Nordeste','Centro-Sul']},
  ]},
  portugues:{nome:'PortuguÃªs',categorias:[
    {titulo:'ğŸ”¹ 1ï¸âƒ£ Base da palavra (estrutura e ortografia)',topicos:['Processo de formaÃ§Ã£o das palavras','Plural dos substantivos','Graus dos adjetivos','AcentuaÃ§Ã£o','HÃ­fen','HomÃ´nimos e parÃ´nimos','Estudo do porquÃª']},
    {titulo:'ğŸ”¹ 2ï¸âƒ£ Classes de palavras (morfologia)',topicos:['Verbos 1','Verbos 2','Verbos 3','Estudo dos pronomes oblÃ­quos e retos','Estudo do SE','Vozes verbais']},
    {titulo:'ğŸ”¹ 3ï¸âƒ£ Sintaxe (estrutura da oraÃ§Ã£o)',topicos:['AnÃ¡lise sintÃ¡tica 1','AnÃ¡lise sintÃ¡tica 2','PerÃ­odo composto','OraÃ§Ãµes subordinadas substantivas e adjetivas','RegÃªncia verbal e nominal','Crase','ConcordÃ¢ncia verbal','ConcordÃ¢ncia nominal','ColocaÃ§Ã£o pronominal']},
    {titulo:'ğŸ”¹ 4ï¸âƒ£ PontuaÃ§Ã£o e organizaÃ§Ã£o do texto',topicos:['PontuaÃ§Ã£o','CoesÃ£o e coerÃªncia']},
    {titulo:'ğŸ”¹ 5ï¸âƒ£ InterpretaÃ§Ã£o e estilÃ­stica',topicos:['Tipologia textual','Tipos de discurso','FunÃ§Ãµes da linguagem','Figuras de linguagem','TÃ³picos especiais']},
  ]},
  matematica:{nome:'MatemÃ¡tica',categorias:[
    {titulo:'ğŸ“ Ãlgebra BÃ¡sica',topicos:['Conjuntos','Conjuntos NumÃ©ricos','FunÃ§Ãµes - DomÃ­nio e ContradomÃ­nio','FunÃ§Ãµes - ClassificaÃ§Ã£o','SequÃªncias - PA','SequÃªncias - PG']},
    {titulo:'ğŸ“ Geometria Plana',topicos:['Geometria Plana - SemelhanÃ§a','Geometria Plana - RelaÃ§Ãµes MÃ©tricas']},
    {titulo:'ğŸ“Š Trigonometria',topicos:['Trigonometria - Arcos e Ã‚ngulos','Trigonometria - FunÃ§Ãµes','Trigonometria - Identidades']},
    {titulo:'ğŸ² AnÃ¡lise CombinatÃ³ria',topicos:['CombinatÃ³ria','Probabilidade']},
    {titulo:'ğŸ”¢ Ãlgebra AvanÃ§ada',topicos:['NÃºmeros Complexos','PolinÃ´mios','Matrizes','Determinantes','Sistemas Lineares']},
    {titulo:'ğŸ“¦ Geometria Espacial',topicos:['Geometria Espacial - Ãreas','Geometria Espacial - Volumes']},
    {titulo:'ğŸ“ˆ Geometria AnalÃ­tica e Vetorial',topicos:['CÃ¡lculo Vetorial','Geometria AnalÃ­tica - Vetores RÂ²','Geometria AnalÃ­tica - Vetores RÂ³','Geometria AnalÃ­tica - EquaÃ§Ã£o da Reta','Geometria AnalÃ­tica - EquaÃ§Ã£o do Plano']},
  ]},
  militar:{nome:'Conhecimento Militar Naval',categorias:[
    {titulo:'âš“ Fundamentos Militares',topicos:['Cerimonial','LideranÃ§a','OGSA','NODAM','JustiÃ§a e Disciplina','Estatuto dos Militares','RDM']},
    {titulo:'ğŸš¢ Conhecimentos MarÃ­timos',topicos:['EmbarcaÃ§Ãµes MiÃºdas','ApresentaÃ§Ã£o Marinheira','SeguranÃ§a da TripulaÃ§Ã£o a Bordo','CAV','CBINC']},
  ]},
  revisao:{nome:'RevisÃ£o Geral',categorias:[{titulo:'ğŸ“š Ciclos de RevisÃ£o',topicos:['RevisÃ£o PortuguÃªs','RevisÃ£o Geografia','RevisÃ£o HistÃ³ria','RevisÃ£o MatemÃ¡tica','RevisÃ£o Militar-Naval']}]},
  exercicios:{nome:'ExercÃ­cios',categorias:[{titulo:'âœï¸ ResoluÃ§Ã£o de QuestÃµes',topicos:['QuestÃµes de PortuguÃªs','QuestÃµes de Geografia','QuestÃµes de HistÃ³ria','QuestÃµes de MatemÃ¡tica','QuestÃµes de Militar-Naval']}]},
  simulados:{nome:'Simulados',categorias:[{titulo:'ğŸ¯ Provas Completas',topicos:['Simulado 1','Simulado 2','Simulado 3','Simulado 4','Simulado 5','Simulado 6']}]},
};

const FASES=[
  {nome:'FASE 1: Base SÃ³lida',periodo:'Novembro - Dezembro',semanas:'Semanas 1-8',cor:'from-blue-800 to-blue-900',tag:'bg-blue-500',
   objetivo:'Construir fundamentos em PortuguÃªs e comeÃ§ar MatemÃ¡tica bÃ¡sica',
   materias:[
    {id:'portugues',nome:'PortuguÃªs',horas:1.5,foco:'GramÃ¡tica essencial, classes de palavras, concordÃ¢ncia',cor:'bg-blue-400'},
    {id:'matematica',nome:'MatemÃ¡tica',horas:1.0,foco:'RevisÃ£o de Ã¡lgebra bÃ¡sica (vocÃª jÃ¡ tem base!)',cor:'bg-purple-400'},
    {id:'militar',nome:'Militar-Naval',horas:0.5,foco:'OGSA e Estatuto dos Militares - leitura inicial',cor:'bg-red-400'},
  ]},
  {nome:'FASE 2: ImersÃ£o',periodo:'Janeiro - Fevereiro',semanas:'Semanas 9-16',cor:'from-green-800 to-green-900',tag:'bg-green-500',
   objetivo:'HistÃ³ria, Geografia e MatemÃ¡tica intermediÃ¡ria',
   materias:[
    {id:'geografia',nome:'Geografia EconÃ´mica',horas:1.0,foco:'GeopolÃ­tica mundial, globalizaÃ§Ã£o, espaÃ§os regionais',cor:'bg-green-400'},
    {id:'historia',nome:'HistÃ³ria Militar-Naval',horas:1.0,foco:'Marinha Imperial, Guerras Mundiais',cor:'bg-orange-400'},
    {id:'matematica',nome:'MatemÃ¡tica',horas:0.5,foco:'Trigonometria, CombinatÃ³ria (reforÃ§o)',cor:'bg-purple-400'},
    {id:'militar',nome:'Militar-Naval CPA/CAP',horas:0.5,foco:'Procedimentos Marinheiros, PEM-2040',cor:'bg-red-400'},
  ]},
  {nome:'FASE 3: Aprofundamento',periodo:'MarÃ§o',semanas:'Semanas 17-20',cor:'from-yellow-800 to-orange-900',tag:'bg-orange-500',
   objetivo:'TÃ³picos complexos e finalizaÃ§Ã£o do conteÃºdo',
   materias:[
    {id:'matematica',nome:'MatemÃ¡tica AvanÃ§ada',horas:1.5,foco:'NÃºmeros Complexos, Matrizes, Geometria AnalÃ­tica',cor:'bg-purple-400'},
    {id:'geografia',nome:'Geografia',horas:1.0,foco:'Brasil, AntÃ¡rtica (PROANTAR), AmÃ©rica Latina',cor:'bg-green-400'},
    {id:'militar',nome:'Militar-Naval CPA/CAP',horas:0.5,foco:'JustiÃ§a/Disciplina MB, Cerimonial, LegislaÃ§Ã£o',cor:'bg-red-400'},
  ]},
  {nome:'FASE 4: RevisÃ£o Final',periodo:'Abril - Maio',semanas:'Semanas 21-28',cor:'from-red-800 to-rose-900',tag:'bg-red-500',
   objetivo:'Simulados, exercÃ­cios e revisÃ£o intensiva',
   materias:[
    {id:'revisao',nome:'RevisÃ£o Geral',horas:1.0,foco:'Ciclos de todas as matÃ©rias com mapas mentais',cor:'bg-yellow-400'},
    {id:'exercicios',nome:'ExercÃ­cios',horas:1.5,foco:'ResoluÃ§Ã£o massiva de questÃµes anteriores',cor:'bg-teal-400'},
    {id:'simulados',nome:'Simulados',horas:0.5,foco:'1-2 simulados completos por semana (5h cada)',cor:'bg-pink-400'},
  ]},
];

const CRONOGRAMA={
   1:{f:0,foco:'PortuguÃªs: Classes de palavras | Mat: Conjuntos'},
   2:{f:0,foco:'PortuguÃªs: ConcordÃ¢ncia nominal | Mat: Conjuntos numÃ©ricos'},
   3:{f:0,foco:'PortuguÃªs: ConcordÃ¢ncia verbal | Mat: FunÃ§Ãµes (domÃ­nio)'},
   4:{f:0,foco:'PortuguÃªs: RegÃªncia | Mat: FunÃ§Ãµes (tipos)'},
   5:{f:0,foco:'PortuguÃªs: ColocaÃ§Ã£o pronominal | Mat: PA e PG'},
   6:{f:0,foco:'PortuguÃªs: RevisÃ£o | Mat: Geometria Plana (triÃ¢ngulos)'},
   7:{f:0,foco:'PortuguÃªs: InterpretaÃ§Ã£o | Mat: Geometria (polÃ­gonos)'},
   8:{f:0,foco:'RevisÃ£o FASE 1 + Leitura OGSA/Estatuto'},
   9:{f:1,foco:'Geografia: GlobalizaÃ§Ã£o | HistÃ³ria: IndependÃªncia'},
  10:{f:1,foco:'Geografia: PopulaÃ§Ã£o | HistÃ³ria: Marinha Imperial'},
  11:{f:1,foco:'Geografia: Guerra Fria | HistÃ³ria: Rev. Industrial'},
  12:{f:1,foco:'Geografia: EUA e UE | HistÃ³ria: Guerra TrÃ­plice AlianÃ§a'},
  13:{f:1,foco:'Geografia: Ãsia | HistÃ³ria: 1Âª Guerra Mundial'},
  14:{f:1,foco:'Trigonometria: arcos/Ã¢ngulos | HistÃ³ria: 2Âª Guerra'},
  15:{f:1,foco:'CombinatÃ³ria | Militar: Procedimentos Marinheiros'},
  16:{f:1,foco:'Probabilidade | Militar: PEM-2040, Doc. Administrativa'},
  17:{f:2,foco:'Mat: NÃºmeros Complexos | Geo: AmÃ©rica Latina'},
  18:{f:2,foco:'Mat: PolinÃ´mios | Geo: Oriente MÃ©dio, Ãfrica'},
  19:{f:2,foco:'Mat: Matrizes e Determinantes | Geo: AntÃ¡rtica'},
  20:{f:2,foco:'Mat: Geometria Espacial | Militar: JustiÃ§a/Cerimonial'},
  21:{f:3,foco:'RevisÃ£o PortuguÃªs + ExercÃ­cios'},
  22:{f:3,foco:'RevisÃ£o Geografia + ExercÃ­cios'},
  23:{f:3,foco:'RevisÃ£o HistÃ³ria + ExercÃ­cios'},
  24:{f:3,foco:'RevisÃ£o MatemÃ¡tica + ExercÃ­cios'},
  25:{f:3,foco:'Simulado 1 + AnÃ¡lise de erros'},
  26:{f:3,foco:'Simulado 2 + Foco nos pontos fracos'},
  27:{f:3,foco:'Simulado 3 + RevisÃ£o final'},
  28:{f:3,foco:'Simulado 4 + Descanso prÃ©-prova'},
};

const FRASES=['A disciplina Ã© a ponte entre objetivos e realizaÃ§Ãµes.','Cada hora de estudo Ã© um passo mais perto do sonho.','O sucesso Ã© a soma de pequenos esforÃ§os repetidos.','Foco, disciplina e determinaÃ§Ã£o â€” sua trilogia do sucesso.','VocÃª estÃ¡ mais perto do que imagina. Continue!','Grandes conquistas exigem grandes sacrifÃ­cios.','O momento de plantar era ontem. O segundo melhor Ã© agora.','A persistÃªncia Ã© o caminho do Ãªxito.'];

const BADGES=[
  {id:'h1', nome:'Primeira Hora',     ic:'â°',desc:'Acumule 1h de estudo',     chk:m=>m.tt>=3600},
  {id:'h5', nome:'DedicaÃ§Ã£o',         ic:'ğŸ“š',desc:'Acumule 5h de estudo',     chk:m=>m.tt>=18000},
  {id:'h20',nome:'Maratonista',       ic:'ğŸƒ',desc:'Acumule 20h de estudo',    chk:m=>m.tt>=72000},
  {id:'h50',nome:'50 Horas',          ic:'ğŸŒŸ',desc:'Acumule 50h de estudo',    chk:m=>m.tt>=180000},
  {id:'s3', nome:'3 Dias Seguidos',   ic:'ğŸ”¥',desc:'3 dias consecutivos',      chk:m=>m.sk>=3},
  {id:'s7', nome:'Semana Perfeita',   ic:'âš¡',desc:'7 dias consecutivos',      chk:m=>m.sk>=7},
  {id:'s30',nome:'MÃªs Invicto',       ic:'ğŸ†',desc:'30 dias consecutivos',     chk:m=>m.sk>=30},
  {id:'p10',nome:'10 Pomodoros',      ic:'ğŸ…',desc:'10 ciclos Pomodoro',       chk:m=>m.pr>=10},
  {id:'p50',nome:'Mestre Pomodoro',   ic:'ğŸ…',desc:'50 ciclos Pomodoro',       chk:m=>m.pr>=50},
  {id:'t1', nome:'Primeiro TÃ³pico',   ic:'âœ…',desc:'Conclua 1 tÃ³pico',         chk:m=>m.tc>=1},
  {id:'t10',nome:'Explorador',        ic:'ğŸ’',desc:'Conclua 10 tÃ³picos',       chk:m=>m.tc>=10},
  {id:'t50',nome:'Mestre',            ic:'ğŸ‘‘',desc:'Conclua 50 tÃ³picos',       chk:m=>m.tc>=50},
];

// â”€â”€â”€ UTILITÃRIOS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt=s=>{const h=Math.floor(s/3600),m=Math.floor((s%3600)/60),sc=s%60;return[h,m,sc].map(n=>String(n).padStart(2,'0')).join(':');};
const fmtMM=s=>fmt(s).slice(3);
const isObj=v=>typeof v==='object'&&v!==null&&!Array.isArray(v);
const hoje=()=>new Date().toISOString().split('T')[0];

// â”€â”€â”€ useLS HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useLS(key,init,v=null){
  const[val,setVal]=useState(()=>{
    try{const r=localStorage.getItem(key);if(r===null)return init;const p=JSON.parse(r);if(v&&!v(p))return init;return p;}catch{return init;}
  });
  useEffect(()=>{try{localStorage.setItem(key,JSON.stringify(val));}catch{}},[key,val]);
  return[val,setVal];
}

// â”€â”€â”€ useCRON HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function useCron(saved,onSave,onReg){
  const[tempos,setTempos]=useState(saved);
  const[ativo,setAtivo]=useState(null);
  const[segs,setSegs]=useState(0);
  const[dIni,setDIni]=useState(null);
  useEffect(()=>{onSave(tempos);},[tempos]);
  useEffect(()=>{if(!ativo)return;const t=setInterval(()=>setSegs(p=>p+1),1000);return()=>clearInterval(t);},[ativo]);
  const iniciar=useCallback((sem,mid)=>{
    const k=`${sem}-${mid}`;
    if(ativo===k){
      const add=Math.max(0,segs-(tempos[k]||0));
      setTempos(p=>({...p,[k]:segs}));onReg(add,dIni||hoje());
      setAtivo(null);setSegs(0);setDIni(null);
    }else{
      if(ativo){const add=Math.max(0,segs-(tempos[ativo]||0));setTempos(p=>({...p,[ativo]:segs}));onReg(add,dIni||hoje());}
      setSegs(tempos[k]||0);setAtivo(k);setDIni(hoje());
    }
  },[ativo,segs,tempos,dIni,onReg]);
  const resetar=useCallback((sem,mid,e)=>{
    e?.stopPropagation();const k=`${sem}-${mid}`;
    if(ativo===k){setAtivo(null);setSegs(0);setDIni(null);}
    setTempos(p=>{const n={...p};delete n[k];return n;});
  },[ativo]);
  const getTempo=useCallback((sem,mid)=>{const k=`${sem}-${mid}`;return ativo===k?segs:(tempos[k]||0);},[ativo,segs,tempos]);
  const getTotal=useCallback((mid)=>{
    let t=0;Object.entries(tempos).forEach(([k,v])=>{if(k.split('-').slice(1).join('-')===mid)t+=v;});
    if(ativo&&ativo.split('-').slice(1).join('-')===mid)t+=segs-(tempos[ativo]||0);
    return t;
  },[tempos,ativo,segs]);
  return{tempos,ativo,segs,iniciar,resetar,getTempo,getTotal};
}

// â”€â”€â”€ usePOMO HOOK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function usePomo(rodIni,onSave){
  const[at,setAt]=useState(false);const[seg,setSeg]=useState(25*60);
  const[tipo,setTipo]=useState('estudo');const[rod,setRod]=useState(rodIni);
  const tRef=useRef(tipo);useEffect(()=>{tRef.current=tipo;},[tipo]);
  useEffect(()=>{onSave(rod);},[rod]);
  useEffect(()=>{
    if(!at)return;
    const som=()=>{try{const c=new(window.AudioContext||window.webkitAudioContext)();[[880,0],[1100,.15],[880,.3]].forEach(([f,d])=>{const o=c.createOscillator(),g=c.createGain();o.connect(g);g.connect(c.destination);o.frequency.value=f;g.gain.value=.3;o.start(c.currentTime+d);o.stop(c.currentTime+d+.15);});}catch{}};
    const t=setInterval(()=>setSeg(p=>{if(p<=1){som();if(tRef.current==='estudo'){setRod(r=>r+1);setTipo('pausa');setAt(false);return 5*60;}else{setTipo('estudo');setAt(false);return 25*60;}}return p-1;}),1000);
    return()=>clearInterval(t);
  },[at]);
  return{at,seg,tipo,rod,iniciar:()=>setAt(true),pausar:()=>setAt(false),resetar:()=>{setAt(false);setTipo('estudo');setSeg(25*60);}};
}

// â”€â”€â”€ REDUCERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const UI0={view:'cronograma',sem:1,exp:{},showS:false,termoS:'',resS:[],showP:false};
function uiR(s,a){switch(a.t){
  case'V':return{...s,view:a.p};case'SEM':return{...s,sem:a.p};
  case'EXP':return{...s,exp:{...s.exp,[a.p]:!s.exp[a.p]}};
  case'SEARCH':return{...s,showS:true,termoS:a.p.t,resS:a.p.r};
  case'CSEARCH':return{...s,showS:false,termoS:'',resS:[]};
  case'POMO':return{...s,showP:!s.showP};default:return s;
}}
const ED0={eN:null,nT:'',eR:null,rT:'',eD:false,dT:'',nT2:{}};
function edR(s,a){switch(a.t){
  case'IN':return{...s,eN:a.k,nT:a.v};case'UN':return{...s,nT:a.p};case'FN':return{...s,eN:null,nT:''};
  case'IR':return{...s,eR:a.k,rT:a.v};case'UR':return{...s,rT:a.p};case'FR':return{...s,eR:null,rT:''};
  case'OD':return{...s,eD:true,dT:a.p};case'UD':return{...s,dT:a.p};case'CD':return{...s,eD:false,dT:''};
  case'SNT':return{...s,nT2:{...s.nT2,[a.k]:a.v}};
  case'CNT':{const{[a.k]:_,...r}=s.nT2;return{...s,nT2:r};}
  default:return s;
}}

// â”€â”€â”€ HEATMAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Heatmap({reg}){
  const base=useMemo(()=>{const d=new Date();d.setHours(12,0,0,0);return d;},[]);
  const dias=useMemo(()=>{const r=[];for(let i=HEATMAP_DIAS-1;i>=0;i--){const d=new Date(base);d.setDate(d.getDate()-i);const ch=d.toISOString().split('T')[0];const s=reg[ch]||0;const eh=i===0;let cor='bg-gray-700';let op='opacity-30';if(s>=7200){cor='bg-green-500';op='opacity-100';}else if(s>=3600){cor='bg-green-500';op='opacity-70';}else if(s>=1800){cor='bg-green-500';op='opacity-50';}else if(s>0){cor='bg-green-500';op='opacity-30';}let df=ch;try{df=d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});}catch{}r.push({ch,s,eh,df,cor,op});}return r;},[reg,base]);
  const off=useMemo(()=>{if(!dias.length)return 0;return new Date(dias[0].ch+'T12:00:00').getDay();},[dias]);
  const cols=Math.ceil((dias.length+off)/7);
  return(
    <div className="bg-gray-800 rounded-2xl p-4 border border-gray-700">
      <div className="flex justify-between items-center mb-3">
        <span className="text-white font-semibold text-sm">ğŸ”¥ Atividade â€” 12 semanas</span>
        <div className="flex items-center gap-1 text-xs text-gray-500">
          <span>menos</span>
          {['bg-gray-700 opacity-30','bg-green-500 opacity-30','bg-green-500 opacity-50','bg-green-500 opacity-70','bg-green-500 opacity-100'].map((c,i)=><div key={i} className={`w-3 h-3 rounded-sm ${c}`}/>)}
          <span>mais</span>
        </div>
      </div>
      <div className="flex gap-1 overflow-x-auto pb-1">
        {Array.from({length:cols},(_,ci)=>(
          <div key={ci} className="flex flex-col gap-1">
            {Array.from({length:7},(_,di)=>{const pos=ci*7+di-off;const d=dias[pos];if(!d)return<div key={di} className="w-3 h-3 opacity-0"/>;return<div key={di} className={`w-3 h-3 rounded-sm cursor-default transition-transform hover:scale-125 ${d.cor} ${d.op} ${d.eh?'ring-2 ring-white ring-offset-1 ring-offset-gray-800':''}`} title={d.s>0?`${d.df}: ${fmt(d.s)}`:`${d.df}: sem estudo`}/>;})}</div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€â”€ DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Dashboard({S}){
  const{streak,diasR,tempoTot,totTop,totSem,frase,reg,badges,pomo,cron,proGeral,dispatchUI}=S;
  const h=(tempoTot/3600).toFixed(1);
  const dias=Object.values(reg).filter(v=>v>0).length;
  const med=dias>0?(tempoTot/3600/dias).toFixed(1):'0.0';
  const totB=Object.keys(badges).length;
  const progMat=useMemo(()=>Object.keys(CONTEUDOS).map(id=>{const mat=CONTEUDOS[id];let t=0,c=0;mat.categorias.forEach((cat,ci)=>{cat.topicos.forEach((_,ti)=>{t++;if(S.topC[`${id}-${ci}-${ti}`])c++;});(S.topP[`${id}-${ci}`]||[]).forEach((_,ti)=>{t++;if(S.topC[`${id}-${ci}-custom-${ti}`])c++;});});return{id,nome:mat.nome,pct:t?Math.round(c/t*100):0};}),[S.topC,S.topP]);
  const matT=useMemo(()=>Object.keys(CONTEUDOS).map(id=>({id,nome:CONTEUDOS[id].nome.split(' ')[0],t:cron.getTotal(id)})).filter(m=>m.t>0).sort((a,b)=>b.t-a.t),[cron]);
  return(
    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900 p-4">
      <div className="max-w-4xl mx-auto space-y-4">
        <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20 text-center">
          <p className="text-white text-opacity-80 italic text-sm">"{frase}"</p>
        </div>
        <div className="grid grid-cols-2 gap-3" style={{gridTemplateColumns:'repeat(4,1fr)'}}>
          {[
            {v:streak,l:'Streak',sub:'dias seguidos',c:'text-orange-400',ic:'ğŸ”¥'},
            {v:h+'h',l:'Total',sub:`~${med}h/dia`,c:'text-blue-400',ic:'â±'},
            {v:totTop,l:'TÃ³picos âœ“',sub:`${totSem} semanas`,c:'text-green-400',ic:'âœ…'},
            {v:diasR,l:'Dias p/prova',sub:'foco total',c:diasR<=30?'text-red-400':'text-yellow-400',ic:'ğŸš©'},
          ].map((c,i)=>(
            <div key={i} className="bg-white bg-opacity-10 rounded-2xl p-3 border border-white border-opacity-10">
              <div className="text-xl mb-1">{c.ic}</div>
              <div className={`text-xl font-bold ${c.c}`}>{c.v}</div>
              <div className="text-white text-opacity-50 text-xs">{c.l}</div>
              <div className="text-white text-opacity-30 text-xs">{c.sub}</div>
            </div>
          ))}
        </div>
        <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20">
          <div className="flex justify-between mb-2"><span className="text-white font-semibold">ğŸ“ˆ Progresso Geral</span><span className="text-white font-bold">{proGeral}%</span></div>
          <div className="w-full bg-white bg-opacity-10 rounded-full" style={{height:10}}>
            <div className="h-full rounded-full bg-gradient-to-r from-blue-400 to-green-400 transition-all duration-700" style={{width:`${proGeral}%`}}/>
          </div>
          <div className="text-white text-opacity-40 text-xs mt-1 text-right">{totSem}/28 semanas concluÃ­das</div>
        </div>
        <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20">
          <h3 className="text-white font-semibold mb-3">ğŸ“š Progresso por MatÃ©ria</h3>
          <div className="space-y-2">
            {progMat.map(m=>(
              <div key={m.id}>
                <div className="flex justify-between text-xs mb-1"><span className="text-white text-opacity-70">{m.nome}</span><span className="text-white text-opacity-50">{m.pct}%</span></div>
                <div className="w-full bg-white bg-opacity-10 rounded-full" style={{height:6}}>
                  <div className="h-full rounded-full bg-blue-400 transition-all" style={{width:`${m.pct}%`}}/>
                </div>
              </div>
            ))}
          </div>
        </div>
        {matT.length>0&&(
          <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20">
            <h3 className="text-white font-semibold mb-3">ğŸ“Š Tempo por MatÃ©ria</h3>
            <div className="space-y-2">
              {matT.map(m=>{const w=Math.min(100,(m.t/3600/5)*100);return(
                <div key={m.id} className="flex items-center gap-3">
                  <span className="text-white text-opacity-60 text-sm" style={{width:80,flexShrink:0}}>{m.nome}</span>
                  <div className="flex-1 bg-white bg-opacity-10 rounded-full" style={{height:8}}>
                    <div className="h-full rounded-full bg-purple-400 transition-all" style={{width:`${w}%`}}/>
                  </div>
                  <span className="text-white text-opacity-50 text-xs" style={{width:56,textAlign:'right',flexShrink:0}}>{fmt(m.t)}</span>
                </div>
              );})}
            </div>
          </div>
        )}
        <Heatmap reg={reg}/>
        <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:16}}>
          <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20">
            <h3 className="text-white font-semibold mb-2">ğŸ… Pomodoro</h3>
            <div className="text-3xl font-bold text-white">{pomo.rod}</div>
            <div className="text-white text-opacity-50 text-sm">ciclos Â· {(pomo.rod*25/60).toFixed(1)}h focadas</div>
          </div>
          <div className="bg-white bg-opacity-10 rounded-2xl p-4 border border-white border-opacity-20">
            <div className="flex justify-between items-start mb-2">
              <h3 className="text-white font-semibold">ğŸ† Conquistas</h3>
              <button onClick={()=>dispatchUI({t:'V',p:'conquistas'})} className="text-xs text-yellow-400">Ver todas â†’</button>
            </div>
            <div className="text-3xl font-bold text-yellow-400">{totB}/{BADGES.length}</div>
            <div className="flex flex-wrap gap-1 mt-2">
              {BADGES.map(b=><span key={b.id} title={b.nome} className={b.id in badges?'text-xl':'text-xl opacity-20 grayscale'}>{b.ic}</span>)}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ CONQUISTAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Conquistas({S}){
  const{badges,setBadges}=S;
  const tot=Object.keys(badges).length;
  const pct=Math.round(tot/BADGES.length*100);
  const resetOne=id=>{const b=BADGES.find(x=>x.id===id);if(!b||!badges[id])return;let df='';try{df=` (${new Date(badges[id]).toLocaleDateString('pt-BR')})`;}catch{}if(!confirm(`Resetar "${b.nome}"${df}?`))return;setBadges(p=>{const n={...p};delete n[id];return n;});};
  const resetAll=()=>{if(!tot){alert('Nenhuma conquista para resetar.');return;}if(!confirm(`Resetar todas as ${tot} conquistas?`))return;setBadges({});};
  return(
    <div className="min-h-screen bg-gradient-to-br from-yellow-900 to-slate-900 p-4">
      <div className="max-w-4xl mx-auto space-y-4">
        <div className="bg-white bg-opacity-10 rounded-2xl p-5 border border-white border-opacity-20">
          <div className="flex justify-between items-start flex-wrap gap-3">
            <div><h2 className="text-2xl font-bold text-yellow-300">ğŸ† Conquistas</h2><p className="text-white text-opacity-50 text-sm mt-1">{tot}/{BADGES.length} badges desbloqueados</p></div>
            <button onClick={resetAll} className="text-sm px-3 py-1.5 rounded-xl text-red-300 transition-colors" style={{backgroundColor:'rgba(239,68,68,0.2)'}}>ğŸ—‘ Resetar Todas</button>
          </div>
          <div className="mt-3">
            <div className="flex justify-between text-xs mb-1" style={{color:'rgba(255,255,255,0.4)'}}><span>Progresso</span><span>{pct}%</span></div>
            <div className="w-full rounded-full" style={{height:8,backgroundColor:'rgba(255,255,255,0.1)'}}>
              <div className="h-full rounded-full transition-all duration-700 bg-gradient-to-r from-yellow-400 to-amber-400" style={{width:`${pct}%`}}/>
            </div>
          </div>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(200px,1fr))',gap:16}}>
          {BADGES.map(b=>{
            const g=!!badges[b.id];let df='';if(g){try{df=new Date(badges[b.id]).toLocaleDateString('pt-BR');}catch{}}
            return(
              <div key={b.id} className="rounded-2xl p-4 border transition-all" style={{
                background:g?'linear-gradient(135deg,rgba(234,179,8,0.3),rgba(245,158,11,0.2))':'rgba(255,255,255,0.05)',
                borderColor:g?'rgba(234,179,8,0.5)':'rgba(255,255,255,0.1)',opacity:g?1:0.5}}>
                <div className="flex justify-between mb-2">
                  <span style={{fontSize:36,filter:g?'none':'grayscale(1)',opacity:g?1:0.4}}>{b.ic}</span>
                  {g&&<button onClick={()=>resetOne(b.id)} style={{color:'rgba(255,255,255,0.2)',fontSize:14}} className="hover:text-red-400 transition-colors">â†º</button>}
                </div>
                <div className="font-semibold text-white text-sm">{b.nome}</div>
                <div className="text-xs mt-1 mb-2" style={{color:'rgba(255,255,255,0.4)'}}>{b.desc}</div>
                {g?<div className="text-xs text-yellow-300">âœ… {df?`em ${df}`:'Conquistado!'}</div>:<div className="text-xs" style={{color:'rgba(255,255,255,0.25)'}}>ğŸ”’ NÃ£o desbloqueado</div>}
              </div>
            );
          })}
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ POMODORO MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PomoModal({pomo,onClose}){
  const total=pomo.tipo==='estudo'?25*60:5*60;
  const pct=(total-pomo.seg)/total*100;
  const r=54,circ=2*Math.PI*r,off=circ*(1-pct/100);
  const cor=pomo.tipo==='estudo'?'#34d399':'#60a5fa';
  return(
    <div className="fixed z-50 rounded-2xl p-4 shadow-2xl" style={{bottom:100,right:16,width:224,background:'#111827',border:'1px solid #374151'}}>
      <div className="flex justify-between items-center mb-3">
        <span className="text-white font-semibold text-sm">ğŸ… Pomodoro</span>
        <button onClick={onClose} style={{color:'#6b7280'}} className="hover:text-white text-lg leading-none">âœ•</button>
      </div>
      <div className="flex justify-between items-center mb-3">
        <span className="text-xs px-2 py-1 rounded-full font-medium" style={{background:cor+'33',color:cor}}>{pomo.tipo==='estudo'?'ğŸ¯ Estudo':'â˜• Pausa'}</span>
        <span className="text-xs" style={{color:'#9ca3af'}}>{pomo.rod} rodada{pomo.rod!==1?'s':''}</span>
      </div>
      <div className="flex justify-center mb-4">
        <div style={{position:'relative',width:112,height:112}}>
          <svg style={{width:'100%',height:'100%',transform:'rotate(-90deg)'}} viewBox="0 0 120 120">
            <circle cx="60" cy="60" r={r} fill="none" stroke="#374151" strokeWidth="8"/>
            <circle cx="60" cy="60" r={r} fill="none" stroke={cor} strokeWidth="8" strokeLinecap="round"
              strokeDasharray={circ} strokeDashoffset={off} style={{transition:'stroke-dashoffset .5s ease'}}/>
          </svg>
          <div style={{position:'absolute',inset:0,display:'flex',alignItems:'center',justifyContent:'center'}}>
            <span className="text-white font-mono font-bold text-xl">{fmtMM(pomo.seg)}</span>
          </div>
        </div>
      </div>
      <div className="flex justify-center gap-3">
        <button onClick={pomo.resetar} className="rounded-xl text-white transition-colors" style={{padding:'8px 12px',background:'#374151'}}>â†º</button>
        <button onClick={pomo.at?pomo.pausar:pomo.iniciar} className="rounded-xl font-medium text-sm transition-colors flex items-center gap-1"
          style={{padding:'8px 20px',background:cor+'33',color:cor}}>
          {pomo.at?'â¸ Pausar':'â–¶ Iniciar'}
        </button>
      </div>
    </div>
  );
}

// â”€â”€â”€ CRONOGRAMA VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function CronogramaView({S}){
  const{ui,dispatchUI,ed,dispatchED,concl,setConcl,diarios,cron,salvarDiario}=S;
  const sem=ui.sem;const setSem=n=>dispatchUI({t:'SEM',p:n});
  const cfg=CRONOGRAMA[sem]||{f:0};
  const fase=FASES[cfg.f]||FASES[0];
  const tempoSem=useMemo(()=>{let t=0;Object.entries(cron.tempos).forEach(([k,v])=>{if(k.startsWith(`${sem}-`))t+=v;});if(cron.ativo?.startsWith(`${sem}-`))t+=cron.segs-(cron.tempos[cron.ativo]||0);return t;},[sem,cron]);
  const metaSem=useMemo(()=>fase.materias.reduce((a,m)=>a+m.horas*3600,0),[fase]);
  const pct=metaSem>0?Math.min(100,Math.round(tempoSem/metaSem*100)):0;
  return(
    <div className="min-h-screen bg-gradient-to-br from-blue-900 via-blue-800 to-slate-900">
      <div style={{position:'sticky',top:0,zIndex:30,padding:'12px 16px',background:'rgba(30,58,138,0.9)',backdropFilter:'blur(8px)',borderBottom:'1px solid rgba(255,255,255,0.1)'}}>
        <div className="max-w-3xl mx-auto">
          <div className="flex justify-between items-center mb-2">
            <div><h1 className="text-white font-bold">ğŸ“š Semana {sem}/28</h1><p style={{color:'rgba(255,255,255,0.5)',fontSize:12}}>{fase.nome} Â· {cfg.foco||''}</p></div>
            <div className="text-right"><span className="text-white font-bold">{pct}%</span><div style={{color:'rgba(255,255,255,0.3)',fontSize:11}}>{fmt(tempoSem)}</div></div>
          </div>
          <div className="w-full rounded-full" style={{height:6,background:'rgba(255,255,255,0.1)'}}>
            <div className="rounded-full transition-all h-full bg-gradient-to-r from-blue-400 to-green-400" style={{width:`${pct}%`}}/>
          </div>
        </div>
      </div>
      <div className="max-w-3xl mx-auto p-4 space-y-4 pb-36">
        <div className="rounded-2xl p-4 border" style={{background:'rgba(255,255,255,0.07)',borderColor:'rgba(255,255,255,0.1)'}}>
          <div className="flex justify-between text-sm mb-2">
            <span style={{color:'rgba(255,255,255,0.6)'}}>Navegar semana</span>
            <span className="text-white font-bold">{sem} / 28</span>
          </div>
          <input type="range" min={1} max={28} value={sem} onChange={e=>setSem(Number(e.target.value))}/>
          <div className="flex justify-between text-xs mt-1" style={{color:'rgba(255,255,255,0.3)'}}>
            {[1,7,14,21,28].map(n=><button key={n} onClick={()=>setSem(n)} className={`hover:text-white transition-colors ${sem===n?'text-blue-400':''}`}>{n}</button>)}
          </div>
        </div>
        {fase.materias.map(mat=><MateriaCard key={mat.id} mat={mat} sem={sem} S={S}/>)}
        <button onClick={()=>setConcl(p=>({...p,[sem]:!p[sem]}))}
          className="w-full rounded-2xl p-4 border flex items-center gap-3 transition-all"
          style={{background:concl[sem]?'rgba(34,197,94,0.2)':'rgba(255,255,255,0.05)',borderColor:concl[sem]?'rgba(74,222,128,0.5)':'rgba(255,255,255,0.1)',color:concl[sem]?'#86efac':'rgba(255,255,255,0.4)'}}>
          <span>{concl[sem]?'âœ…':'â—‹'}</span>
          <span className="font-medium">{concl[sem]?'Semana concluÃ­da!':'Marcar como concluÃ­da'}</span>
        </button>
        <div className="rounded-2xl p-4 border" style={{background:'rgba(255,255,255,0.07)',borderColor:'rgba(255,255,255,0.1)'}}>
          <div className="flex justify-between items-center mb-3">
            <span style={{color:'rgba(255,255,255,0.7)',fontWeight:500,fontSize:14}}>ğŸ““ DiÃ¡rio da semana</span>
            {!ed.eD&&<button onClick={()=>dispatchED({t:'OD',p:diarios[sem]||''})} style={{fontSize:12,color:'#93c5fd'}} className="hover:text-blue-200">{diarios[sem]?'Editar':'+ Escrever'}</button>}
          </div>
          {ed.eD?(
            <>
              <textarea autoFocus value={ed.dT} onChange={e=>dispatchED({t:'UD',p:e.target.value})}
                placeholder="Como foi o estudo desta semana?" rows={4}
                className="w-full rounded-xl text-white text-sm p-3 outline-none resize-none"
                style={{background:'#1f2937',border:'1px solid rgba(96,165,250,0.3)'}}/>
              <div className="flex gap-2 mt-2">
                <button onClick={()=>salvarDiario(sem,ed.dT)} className="text-sm px-4 py-1.5 rounded-xl transition-colors" style={{background:'rgba(59,130,246,0.3)',color:'#93c5fd'}}>Salvar</button>
                <button onClick={()=>dispatchED({t:'CD'})} className="text-sm px-4 py-1.5 transition-colors" style={{color:'rgba(255,255,255,0.3)'}}>Cancelar</button>
              </div>
            </>
          ):diarios[sem]?<p className="text-sm whitespace-pre-wrap" style={{color:'rgba(255,255,255,0.6)'}}>{diarios[sem]}</p>
          :<p className="text-sm italic" style={{color:'rgba(255,255,255,0.2)'}}>Nenhuma anotaÃ§Ã£o para esta semana.</p>}
        </div>
      </div>
    </div>
  );
}

function MateriaCard({mat,sem,S}){
  const{ui,dispatchUI,ed,dispatchED,topC,setTopC,topP,setTopP,topR,setTopR,resumos,setResumos,topRen,setTopRen,cron,salvarResumo}=S;
  const k=`${mat.id}-${sem}`;const exp=ui.exp[k];const toggle=()=>dispatchUI({t:'EXP',p:k});
  const md=CONTEUDOS[mat.id];const tempo=cron.getTempo(sem,mat.id);const at=cron.ativo===`${sem}-${mat.id}`;
  const meta=mat.horas*3600;const pct=meta>0?Math.min(100,Math.round(tempo/meta*100)):0;
  const progT=useMemo(()=>{if(!md)return 0;let t=0,c=0;md.categorias.forEach((cat,ci)=>{cat.topicos.forEach((_,ti)=>{t++;if(topC[`${mat.id}-${ci}-${ti}`])c++;});(topP[`${mat.id}-${ci}`]||[]).forEach((_,ti)=>{t++;if(topC[`${mat.id}-${ci}-custom-${ti}`])c++;});});return t?Math.round(c/t*100):0;},[topC,topP,mat.id]);
  return(
    <div className="rounded-2xl border transition-all duration-300" style={{background:'rgba(255,255,255,0.07)',borderColor:at?'rgba(96,165,250,0.7)':'rgba(255,255,255,0.1)',boxShadow:at?'0 0 20px rgba(96,165,250,0.2)':'none'}}>
      <div className="p-4">
        <div className="flex items-center justify-between mb-3">
          <div className="flex items-center gap-3 flex-1 min-w-0">
            <div className={`w-3 h-3 rounded-full shrink-0 ${mat.cor}`}/>
            <div className="min-w-0"><div className="text-white font-semibold text-sm truncate">{mat.nome}</div><div className="text-xs truncate" style={{color:'rgba(255,255,255,0.4)'}}>{mat.foco}</div></div>
          </div>
          <div className="flex items-center gap-2 ml-2 shrink-0">
            <span className={`font-mono text-sm ${at?'text-blue-300 pulse':'text-white text-opacity-60'}`}>{fmt(tempo)}</span>
            <button onClick={()=>cron.iniciar(sem,mat.id)} className="p-2 rounded-xl transition-all" style={{background:at?'rgba(59,130,246,0.3)':'rgba(255,255,255,0.1)',color:at?'#93c5fd':'rgba(255,255,255,0.6)'}}>{at?'â¸':'â–¶'}</button>
            <button onClick={e=>cron.resetar(sem,mat.id,e)} className="p-2 rounded-xl transition-all text-xs" style={{background:'rgba(255,255,255,0.05)',color:'rgba(255,255,255,0.2)'}}>â†º</button>
          </div>
        </div>
        <div className="flex items-center gap-2 mb-1">
          <div className="flex-1 rounded-full" style={{height:6,background:'rgba(255,255,255,0.1)'}}>
            <div className="h-full rounded-full transition-all" style={{width:`${pct}%`,background:pct>=100?'#4ade80':at?'#60a5fa':'rgba(255,255,255,0.3)'}}/>
          </div>
          <span className="text-xs shrink-0" style={{color:'rgba(255,255,255,0.3)'}}>{pct}% Â· {mat.horas}h</span>
        </div>
        <div className="flex justify-between items-center">
          <span className="text-xs" style={{color:'rgba(255,255,255,0.3)'}}>{progT}% tÃ³picos âœ“</span>
          {md&&<button onClick={toggle} className="text-xs flex items-center gap-1 transition-colors" style={{color:'#93c5fd'}}>{exp?'â–¾ Ocultar':'â–¸ TÃ³picos'}</button>}
        </div>
      </div>
      {exp&&md&&(
        <div className="p-4 space-y-4" style={{borderTop:'1px solid rgba(255,255,255,0.1)'}}>
          {md.categorias.map((cat,ci)=>(
            <div key={ci}>
              <div className="uppercase tracking-wider font-medium mb-2 text-xs" style={{color:'rgba(255,255,255,0.3)'}}>{cat.titulo}</div>
              <div className="space-y-1">
                {cat.topicos.map((orig,ti)=><TopicoItem key={ti} mid={mat.id} ci={ci} ti={ti} orig={orig} custom={false} S={S}/>)}
                {(topP[`${mat.id}-${ci}`]||[]).map((orig,ti)=><TopicoItem key={`c${ti}`} mid={mat.id} ci={ci} ti={ti} orig={orig} custom={true} S={S}/>)}
                <AddT mid={mat.id} ci={ci} S={S}/>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function TopicoItem({mid,ci,ti,orig,custom,S}){
  const{topC,setTopC,topR,setTopR,topP,setTopP,resumos,setResumos,topRen,setTopRen,ed,dispatchED,salvarResumo}=S;
  const k=custom?`${mid}-${ci}-custom-${ti}`:`${mid}-${ci}-${ti}`;
  const nome=topRen[k]||orig;const ok=!!topC[k],rev=!!topR[k],hr=!!resumos[k];
  const eN=ed.eN===k,eR=ed.eR===k;
  const togOk=()=>{const n=!ok;setTopC(p=>({...p,[k]:n}));if(n)setTopR(p=>{const x={...p};delete x[k];return x;});};
  const togRev=()=>{if(ok)return;setTopR(p=>({...p,[k]:!p[k]}));};
  const rem=()=>{const ch=`${mid}-${ci}`;setTopP(p=>{const l=[...(p[ch]||[])];l.splice(ti,1);return{...p,[ch]:l};});setTopC(p=>{const n={...p};delete n[k];return n;});setTopR(p=>{const n={...p};delete n[k];return n;});};
  return(
    <div id={`t-${k}`} className="rounded-xl p-2 transition-all" style={{background:ok?'rgba(34,197,94,0.1)':rev?'rgba(234,179,8,0.1)':'rgba(255,255,255,0.05)'}}>
      <div className="flex items-center gap-2">
        <button onClick={togOk} className="shrink-0 text-base">{ok?'âœ…':'â¬œ'}</button>
        {eN?(
          <input autoFocus value={ed.nT} onChange={e=>dispatchED({t:'UN',p:e.target.value})}
            onKeyDown={e=>{if(e.key==='Enter'){setTopRen(p=>({...p,[k]:ed.nT}));dispatchED({t:'FN'});}if(e.key==='Escape')dispatchED({t:'FN'});}}
            className="flex-1 text-white text-xs rounded px-2 py-0.5 outline-none"
            style={{background:'rgba(255,255,255,0.1)',border:'1px solid rgba(96,165,250,0.5)'}}/>
        ):(
          <span className="flex-1 text-xs" style={{color:ok?'rgba(255,255,255,0.3)':'rgba(255,255,255,0.8)',textDecoration:ok?'line-through':'none'}}>
            {nome}{custom&&<span style={{color:'#a78bfa',marginLeft:4}}>*</span>}
            {hr&&<span title="Tem nota" style={{marginLeft:4}}>ğŸ“</span>}
          </span>
        )}
        <div className="flex items-center gap-1 shrink-0">
          {eN?(
            <>
              <button onClick={()=>{setTopRen(p=>({...p,[k]:ed.nT}));dispatchED({t:'FN'});}} style={{color:'#4ade80',fontSize:12}}>âœ“</button>
              <button onClick={()=>dispatchED({t:'FN'})} style={{color:'#f87171',fontSize:12}}>âœ•</button>
            </>
          ):(
            <>
              {!ok&&<button onClick={togRev} title="Marcar p/revisar" style={{fontSize:11,color:rev?'#fbbf24':'rgba(255,255,255,0.2)',cursor:'pointer'}}>âš </button>}
              <button onClick={()=>dispatchED({t:'IN',k,v:nome})} title="Renomear" style={{fontSize:11,color:'rgba(255,255,255,0.2)',cursor:'pointer'}} className="hover:text-blue-300">âœ</button>
              <button onClick={()=>dispatchED({t:'IR',k,v:resumos[k]||''})} title="Nota" style={{fontSize:11,color:hr?'#60a5fa':'rgba(255,255,255,0.2)',cursor:'pointer'}}>ğŸ“</button>
              {custom&&<button onClick={rem} title="Remover" style={{fontSize:11,color:'rgba(255,255,255,0.2)',cursor:'pointer'}} className="hover:text-red-400">ğŸ—‘</button>}
            </>
          )}
        </div>
      </div>
      {eR&&(
        <div style={{marginTop:8}}>
          <textarea autoFocus value={ed.rT} onChange={e=>dispatchED({t:'UR',p:e.target.value})}
            placeholder="AnotaÃ§Ãµes, palavras-chaveâ€¦" rows={3}
            className="w-full text-white text-xs rounded-lg p-2 outline-none resize-none"
            style={{background:'#1f2937',border:'1px solid rgba(96,165,250,0.4)'}}/>
          <div className="flex gap-2 mt-1">
            <button onClick={()=>salvarResumo(k,ed.rT)} className="text-xs px-3 py-1 rounded-lg transition-colors" style={{background:'rgba(59,130,246,0.3)',color:'#93c5fd'}}>Salvar</button>
            <button onClick={()=>dispatchED({t:'FR'})} className="text-xs px-3 py-1 transition-colors" style={{color:'rgba(255,255,255,0.3)'}}>Cancelar</button>
          </div>
        </div>
      )}
    </div>
  );
}

function AddT({mid,ci,S}){
  const{ed,dispatchED,topP,setTopP}=S;const ch=`${mid}-${ci}`;const txt=ed.nT2[ch]||'';
  const add=()=>{if(!txt.trim())return;setTopP(p=>({...p,[ch]:[...(p[ch]||[]),txt.trim()]}));dispatchED({t:'CNT',k:ch});};
  return(
    <div className="flex items-center gap-2 mt-1">
      <input value={txt} onChange={e=>dispatchED({t:'SNT',k:ch,v:e.target.value})} onKeyDown={e=>{if(e.key==='Enter')add();}}
        placeholder="+ Adicionar tÃ³picoâ€¦" className="flex-1 text-xs rounded-lg px-2 py-1 outline-none"
        style={{background:'rgba(255,255,255,0.05)',color:'rgba(255,255,255,0.5)',border:'1px solid rgba(255,255,255,0.1)'}}/>
      {txt.trim()&&<button onClick={add} style={{color:'#60a5fa',fontSize:14}}>âœ“</button>}
    </div>
  );
}

// â”€â”€â”€ REVISÃƒO VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function RevisaoView({S}){
  const{topR,setTopR,topC,setTopC,topP,topRen}=S;
  const lista=useMemo(()=>{const r=[];Object.entries(topR).forEach(([k,at])=>{if(!at)return;const pts=k.split('-');const cu=pts.includes('custom');let mid,ci,ti;if(cu){const ix=pts.indexOf('custom');ti=parseInt(pts[ix+1]);ci=parseInt(pts[ix-1]);mid=pts.slice(0,ix-1).join('-');}else{ti=parseInt(pts[pts.length-1]);ci=parseInt(pts[pts.length-2]);mid=pts.slice(0,-2).join('-');}const mat=CONTEUDOS[mid];if(!mat)return;let nm=cu?(S.topP[`${mid}-${ci}`]||[])[ti]:mat.categorias[ci]?.topicos[ti];if(!nm)return;r.push({k,mid,mn:mat.nome,nome:topRen[k]||nm,cu});});return r;},[topR,topP,topRen]);
  const ok=item=>{setTopC(p=>({...p,[item.k]:true}));setTopR(p=>{const n={...p};delete n[item.k];return n;});};
  const rm=k=>setTopR(p=>{const n={...p};delete n[k];return n;});
  return(
    <div className="min-h-screen p-4 bg-gradient-to-br from-yellow-900 to-slate-900">
      <div className="max-w-3xl mx-auto space-y-4">
        <div className="rounded-2xl p-5 border" style={{background:'rgba(255,255,255,0.07)',borderColor:'rgba(255,255,255,0.1)'}}>
          <h2 className="text-xl font-bold text-yellow-300">âš  Para Revisar</h2>
          <p className="text-sm mt-1" style={{color:'rgba(255,255,255,0.5)'}}>{lista.length} tÃ³pico{lista.length!==1?'s':''} marcado{lista.length!==1?'s':''}</p>
        </div>
        {lista.length===0?(
          <div className="rounded-2xl p-8 text-center" style={{background:'rgba(255,255,255,0.05)',color:'rgba(255,255,255,0.3)'}}>
            <div className="text-4xl mb-2">âœ…</div><div>Nenhum tÃ³pico marcado para revisÃ£o.</div>
            <div className="text-sm mt-1">Use o âš  no cronograma para marcar tÃ³picos.</div>
          </div>
        ):(
          <div className="space-y-2">
            {lista.map(item=>(
              <div key={item.k} className="rounded-xl p-4 flex items-center justify-between gap-3" style={{background:'rgba(255,255,255,0.07)',border:'1px solid rgba(234,179,8,0.2)'}}>
                <div className="min-w-0">
                  <div className="text-xs mb-0.5" style={{color:'rgba(234,179,8,0.7)'}}>{item.mn}</div>
                  <div className="text-white text-sm truncate">{item.nome}</div>
                  {item.cu&&<div className="text-xs" style={{color:'#a78bfa'}}>â€¢ personalizado</div>}
                </div>
                <div className="flex gap-2 shrink-0">
                  <button onClick={()=>ok(item)} className="text-xs px-3 py-1.5 rounded-lg transition-colors" style={{background:'rgba(34,197,94,0.2)',color:'#86efac'}}>âœ“ Conclui</button>
                  <button onClick={()=>rm(item.k)} className="text-xs px-2 py-1.5 rounded-lg transition-colors" style={{background:'rgba(255,255,255,0.1)',color:'rgba(255,255,255,0.5)'}}>âœ•</button>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// â”€â”€â”€ MODAL PESQUISA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SearchModal({S}){
  const{ui,dispatchUI,topP,resumos}=S;
  const[termo,setTermo]=useState('');
  const inputRef=useRef(null);

  // Foca o input sempre que o modal abrir
  useEffect(()=>{
    setTimeout(()=>{if(inputRef.current)inputRef.current.focus();},50);
  },[]);

  const buscar=t=>{
    setTermo(t);
    // CORREÃ‡ÃƒO: nÃ£o fecha o modal ao digitar â€” apenas limpa resultados se < 2 chars
    if(t.length<2){
      dispatchUI({t:'SEARCH',p:{t:'',r:[]}});
      return;
    }
    const tl=t.toLowerCase(),res=[];
    Object.entries(CONTEUDOS).forEach(([mid,mat])=>{
      mat.categorias.forEach((cat,ci)=>{
        cat.topicos.forEach((top,ti)=>{const k=`${mid}-${ci}-${ti}`;if(top.toLowerCase().includes(tl)||resumos[k]?.toLowerCase().includes(tl))res.push({mid,mn:mat.nome,top,k,custom:false});});
        (topP[`${mid}-${ci}`]||[]).forEach((top,ti)=>{const k=`${mid}-${ci}-custom-${ti}`;if(top.toLowerCase().includes(tl))res.push({mid,mn:mat.nome,top,k,custom:true});});
      });
    });
    dispatchUI({t:'SEARCH',p:{t,r:res}});
  };
  const ir=res=>{
    dispatchUI({t:'CSEARCH'});dispatchUI({t:'V',p:'cronograma'});
    setTimeout(()=>{const el=document.getElementById(`t-${res.k}`);if(el){el.scrollIntoView({behavior:'smooth',block:'center'});el.style.outline='2px solid #fbbf24';setTimeout(()=>el.style.outline='',2000);}else setTimeout(()=>{const el2=document.getElementById(`t-${res.k}`);if(el2){el2.scrollIntoView({behavior:'smooth',block:'center'});}},300);},100);
  };
  const hl=(txt,t)=>{if(!t)return txt;const pts=[];let r=txt;let i=0;while(r.length>0&&i<100){const idx=r.toLowerCase().indexOf(t.toLowerCase());if(idx===-1){pts.push(<span key={i}>{r}</span>);break;}if(idx>0)pts.push(<span key={i+'a'}>{r.slice(0,idx)}</span>);pts.push(<mark key={i+'b'} style={{background:'rgba(251,191,36,0.4)',color:'#fde68a',borderRadius:3,padding:'0 2px'}}>{r.slice(idx,idx+t.length)}</mark>);r=r.slice(idx+t.length);i++;}return pts;};
  return(
    <div style={{position:'fixed',inset:0,zIndex:50,background:'rgba(0,0,0,0.7)',display:'flex',alignItems:'flex-start',justifyContent:'center',paddingTop:64,paddingLeft:16,paddingRight:16}}
      onClick={e=>{if(e.target===e.currentTarget)dispatchUI({t:'CSEARCH'});}}>
      <div className="w-full max-w-lg rounded-2xl shadow-2xl overflow-hidden slide-in" style={{background:'#1f2937'}}
        onClick={e=>e.stopPropagation()}>
        <div className="flex items-center gap-3 p-4" style={{borderBottom:'1px solid #374151'}}>
          <span style={{color:'#9ca3af'}}>ğŸ”</span>
          <input
            ref={inputRef}
            value={termo}
            onChange={e=>buscar(e.target.value)}
            onKeyDown={e=>{if(e.key==='Escape')dispatchUI({t:'CSEARCH'});}}
            placeholder="Buscar tÃ³picoâ€¦ (mÃ­n. 2 caracteres)"
            className="flex-1 text-white outline-none"
            style={{background:'transparent'}}
          />
          <button onClick={()=>dispatchUI({t:'CSEARCH'})} style={{color:'#9ca3af'}} className="hover:text-white">âœ•</button>
        </div>
        <div style={{maxHeight:384,overflowY:'auto'}}>
          {termo.length>0&&termo.length<2&&<div className="p-4 text-sm text-center" style={{color:'#9ca3af'}}>Continue digitandoâ€¦</div>}
          {termo.length>=2&&ui.resS.length===0&&<div className="p-4 text-sm text-center" style={{color:'#9ca3af'}}>Nenhum resultado para "{termo}"</div>}
          {ui.resS.map(r=>(
            <button key={r.k} onClick={()=>ir(r)} className="w-full text-left px-4 py-3 hover:bg-gray-700 transition-colors">
              <div className="text-xs mb-0.5" style={{color:'#60a5fa'}}>{r.mn}</div>
              <div className="text-sm text-white">{hl(r.top,termo)}</div>
              {r.custom&&<div className="text-xs" style={{color:'#a78bfa'}}>â€¢ personalizado</div>}
            </button>
          ))}
        </div>
        {ui.resS.length>0&&<div className="px-4 py-2 text-xs" style={{borderTop:'1px solid #374151',color:'#6b7280'}}>{ui.resS.length} resultado(s) Â· ESC para fechar</div>}
      </div>
    </div>
  );
}

// â”€â”€â”€ TOAST BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Toast({badge}){if(!badge)return null;return(
  <div style={{position:'fixed',top:16,right:16,zIndex:60,background:'linear-gradient(135deg,#f59e0b,#d97706)',color:'#000',padding:16,borderRadius:16,boxShadow:'0 20px 40px rgba(0,0,0,0.5)',display:'flex',alignItems:'center',gap:12,maxWidth:280}} className="slide-in">
    <span style={{fontSize:32}}>{badge.ic}</span>
    <div><div style={{fontWeight:'bold',fontSize:14}}>ğŸ‰ Conquista Desbloqueada!</div><div style={{fontWeight:500,fontSize:13}}>{badge.nome}</div><div style={{fontSize:11,opacity:.7}}>{badge.desc}</div></div>
  </div>
);}

// â”€â”€â”€ NAVBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function NavBar({view,dispatchUI}){
  const abas=[{id:'dashboard',l:'Dashboard',ic:'ğŸ“Š'},{id:'cronograma',l:'Cronograma',ic:'ğŸ“…'},{id:'revisao',l:'RevisÃ£o',ic:'âš '},{id:'conquistas',l:'Conquistas',ic:'ğŸ†'}];
  return(
    <nav style={{position:'fixed',bottom:0,left:0,right:0,zIndex:40,background:'rgba(17,24,39,0.95)',backdropFilter:'blur(8px)',borderTop:'1px solid #1f2937',display:'flex'}}>
      {abas.map(a=>(
        <button key={a.id} onClick={()=>dispatchUI({t:'V',p:a.id})}
          style={{flex:1,padding:'8px 0',display:'flex',flexDirection:'column',alignItems:'center',gap:2,fontSize:11,color:view===a.id?'#60a5fa':'#6b7280',border:'none',background:'none',cursor:'pointer',transition:'color .2s'}}>
          <span style={{fontSize:18,lineHeight:1}}>{a.ic}</span>
          <span>{a.l}</span>
        </button>
      ))}
    </nav>
  );
}

// â”€â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App({uid,userName,onLogout}){
  const[concl,setConcl]   =useLS(LS.C,{},isObj);
  const[topC,setTopC]     =useLS(LS.TC,{},isObj);
  const[topP,setTopP]     =useLS(LS.TP,{},isObj);
  const[resumos,setResumos]=useLS(LS.R,{},isObj);
  const[reg,setReg]       =useLS(LS.RD,{},isObj);
  const[diarios,setDiarios]=useLS(LS.D,{},isObj);
  const[topR,setTopR]     =useLS(LS.TR,{},isObj);
  const[badges,setBadges] =useLS(LS.B,{},isObj);
  const[topRen,setTopRen] =useLS(LS.RN,{},isObj);
  const[dataProva,setDataProva]=useLS(LS.DP,DATA_PROVA_PAD,v=>typeof v==='string');
  const[tSaved,setTSaved] =useLS(LS.T,{},isObj);
  const[pRodSaved,setPRodSaved]=useLS(LS.PR,0,v=>typeof v==='number');
  const[ui,dispatchUI]=useReducer(uiR,UI0);
  const[ed,dispatchED]=useReducer(edR,ED0);
  const[toast,setToast]=useState(null);
  const[frase]=useState(()=>FRASES[Math.floor(Math.random()*FRASES.length)]);
  const[syncOk,setSyncOk]=useState(null);
  const saveRef=useRef(null);
  const listenerRef=useRef(null);

  // â”€â”€ SOLUÃ‡ÃƒO DEFINITIVA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Tudo parte do onAuthStateChanged: listener + save sÃ³ rodam
  // quando o uid real do Google jÃ¡ estÃ¡ confirmado pelo Firebase.
  useEffect(()=>{
    if(!window.auth||!window.db)return;

    const unsub=window.auth.onAuthStateChanged(firebaseUser=>{
      // SeguranÃ§a: ignora se o user autenticado nÃ£o bater com o prop uid
      if(!firebaseUser||firebaseUser.uid!==uid)return;

      // Guarda uid confirmado em window para o save poder acessar
      window._confirmedUid=firebaseUser.uid;

      // Remove listener anterior se existir
      if(listenerRef.current){
        window.db.ref(`/usuarios/${window._confirmedUid}`).off('value',listenerRef.current);
      }

      // âœ… Listener em tempo real â€” qualquer device que salvar, todos recebem
      const ref=window.db.ref(`/usuarios/${window._confirmedUid}`);
      listenerRef.current=ref.on('value',snap=>{
        const d=snap.val();
        if(d){
          if(d.concluidos&&isObj(d.concluidos))setConcl(d.concluidos);
          if(d.topicosCompletos&&isObj(d.topicosCompletos))setTopC(d.topicosCompletos);
          if(d.topicosPersonalizados&&isObj(d.topicosPersonalizados))setTopP(d.topicosPersonalizados);
          if(d.resumos&&isObj(d.resumos))setResumos(d.resumos);
          if(d.registrosDiarios&&isObj(d.registrosDiarios))setReg(d.registrosDiarios);
          if(d.diarios&&isObj(d.diarios))setDiarios(d.diarios);
          if(d.topicosRevisar&&isObj(d.topicosRevisar))setTopR(d.topicosRevisar);
          if(d.badges&&isObj(d.badges))setBadges(d.badges);
          if(d.topicosRenomeados&&isObj(d.topicosRenomeados))setTopRen(d.topicosRenomeados);
          if(d.dataProva&&typeof d.dataProva==='string')setDataProva(d.dataProva);
          if(d.tempos&&isObj(d.tempos))setTSaved(d.tempos);
          if(typeof d.pomodoroRodadas==='number')setPRodSaved(d.pomodoroRodadas);
        }
        setSyncOk(true);
      },()=>setSyncOk(false));
    });

    return()=>{
      unsub();
      if(listenerRef.current&&window._confirmedUid){
        window.db.ref(`/usuarios/${window._confirmedUid}`).off('value',listenerRef.current);
      }
    };
  },[uid]);

  // âœ… Save com .update() â€” nunca sobrescreve, mescla os dados
  // SÃ³ roda se _confirmedUid existir (ou seja, auth jÃ¡ confirmou)
  useEffect(()=>{
    clearTimeout(saveRef.current);
    saveRef.current=setTimeout(()=>{
      const confirmedUid=window._confirmedUid;
      if(!window.db||!confirmedUid){
        console.warn('[Firebase] Save bloqueado â€” uid ainda nÃ£o confirmado.');
        return;
      }
      console.log('[Firebase] Salvando em /usuarios/'+confirmedUid);
      window.db.ref(`/usuarios/${confirmedUid}`).update({
        concluidos:concl,topicosCompletos:topC,topicosPersonalizados:topP,
        resumos,registrosDiarios:reg,diarios,topicosRevisar:topR,
        badges,topicosRenomeados:topRen,dataProva,tempos:tSaved,pomodoroRodadas:pRodSaved
      }).then(()=>{console.log('[Firebase] âœ… Salvo!');setSyncOk(true);})
        .catch(e=>{console.error('[Firebase] âŒ Erro:',e.message);setSyncOk(false);});
    },3000);
  },[concl,topC,topP,resumos,reg,diarios,topR,badges,topRen,dataProva,tSaved,pRodSaved]);

  const regHoje=useCallback((seg,data)=>{if(seg<=0)return;const d=data||hoje();setReg(p=>({...p,[d]:(p[d]||0)+seg}));},[]);
  const cron=useCron(tSaved,setTSaved,regHoje);
  const pomo=usePomo(pRodSaved,setPRodSaved);

  const streak=useMemo(()=>{let c=0;const d=new Date();const hj=d.toISOString().split('T')[0];if(!reg[hj]||reg[hj]<STREAK_MIN)d.setDate(d.getDate()-1);for(let i=0;i<365;i++){const s=d.toISOString().split('T')[0];if(reg[s]&&reg[s]>=STREAK_MIN){c++;d.setDate(d.getDate()-1);}else break;}return c;},[reg]);
  const diasR=useMemo(()=>{const p=new Date(`${dataProva}T12:00:00`);return Math.max(0,Math.ceil((p-new Date())/86400000));},[dataProva]);
  const tempoTot=useMemo(()=>Object.values(reg).reduce((a,v)=>a+v,0),[reg]);
  const totTop=useMemo(()=>Object.values(topC).filter(Boolean).length,[topC]);
  const totSem=useMemo(()=>Object.values(concl).filter(Boolean).length,[concl]);
  const proGeral=useMemo(()=>Math.round(totSem/28*100),[totSem]);

  useEffect(()=>{
    const m={tt:tempoTot,sk:streak,pr:pomo.rod,tc:totTop};
    BADGES.forEach(b=>{if(!badges[b.id]&&b.chk(m)){setBadges(p=>({...p,[b.id]:new Date().toISOString()}));setToast(b);setTimeout(()=>setToast(null),TOAST_MS);}});
  },[tempoTot,streak,pomo.rod,totTop,badges]);

  const salvarResumo=useCallback((k,txt)=>{setResumos(p=>{if(!txt?.trim()){const n={...p};delete n[k];return n;}return{...p,[k]:txt.trim()};});dispatchED({t:'FR'});},[]);
  const salvarDiario=useCallback((sem,txt)=>{setDiarios(p=>({...p,[String(sem)]:txt}));dispatchED({t:'CD'});},[]);

  const exportar=()=>{const d={versao:'2.0',exportadoEm:new Date().toISOString(),tempos:cron.tempos,concluidos:concl,topicosCompletos:topC,topicosPersonalizados:topP,resumos,registrosDiarios:reg,diarios,topicosRevisar:topR,badgesGanhos:badges,pomodoroRodadas:pomo.rod,topicosRenomeados:topRen,dataProva};const b=new Blob([JSON.stringify(d,null,2)],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');a.href=u;a.download=`estudo-backup-${hoje()}.json`;a.click();URL.revokeObjectURL(u);};
  const importar=e=>{const f=e.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=ev=>{try{const d=JSON.parse(ev.target.result);if(!d||typeof d!=='object'){alert('âŒ Arquivo invÃ¡lido.');return;}if(d.concluidos)setConcl(d.concluidos);if(d.topicosCompletos)setTopC(d.topicosCompletos);if(d.topicosPersonalizados)setTopP(d.topicosPersonalizados);if(d.resumos)setResumos(d.resumos);if(d.registrosDiarios)setReg(d.registrosDiarios);if(d.diarios)setDiarios(d.diarios);if(d.topicosRevisar)setTopR(d.topicosRevisar);if(d.badgesGanhos)setBadges(d.badgesGanhos);if(d.topicosRenomeados)setTopRen(d.topicosRenomeados);if(d.dataProva)setDataProva(d.dataProva);if(d.tempos)setTSaved(d.tempos);alert(`âœ… Dados importados! (v${d.versao||'?'})`);}catch(err){alert('âŒ Erro: '+err.message);}};r.readAsText(f);e.target.value='';};
  const resetar=()=>{if(!confirm('âš ï¸ Apagar TODOS os dados? Esta aÃ§Ã£o Ã© irreversÃ­vel.\n\nExporte um backup antes!'))return;try{Object.values(LS).forEach(k=>localStorage.removeItem(k));setTimeout(()=>window.location.reload(),100);}catch(err){alert('Erro: '+err.message);}};

  const S={ui,dispatchUI,ed,dispatchED,concl,setConcl,topC,setTopC,topP,setTopP,resumos,setResumos,reg,setReg,diarios,topR,setTopR,badges,setBadges,topRen,setTopRen,dataProva,setDataProva,streak,diasR,tempoTot,totTop,totSem,proGeral,frase,cron,pomo,salvarResumo,salvarDiario,FASES,CRONOGRAMA};
  const{view}=ui;

  return(
    <div style={{minHeight:'100vh',background:'#0f172a',color:'white'}}>
      <Toast badge={toast}/>
      {ui.showS&&<SearchModal S={S}/>}
      {ui.showP&&<PomoModal pomo={pomo} onClose={()=>dispatchUI({t:'POMO'})}/>}
      <div style={{paddingBottom:80}}>
        {view==='dashboard'  &&<Dashboard S={S}/>}
        {view==='cronograma' &&<CronogramaView S={S}/>}
        {view==='revisao'    &&<RevisaoView S={S}/>}
        {view==='conquistas' &&<Conquistas S={S}/>}
      </div>
      {/* Toolbar flutuante */}
      <div style={{position:'fixed',bottom:68,left:0,right:0,zIndex:30,display:'flex',justifyContent:'center',pointerEvents:'none'}}>
        <div style={{display:'flex',alignItems:'center',gap:8,background:'rgba(17,24,39,0.95)',backdropFilter:'blur(8px)',border:'1px solid #374151',borderRadius:24,padding:'6px 16px',pointerEvents:'auto'}}>
          <button onClick={()=>dispatchUI({t:'SEARCH',p:{t:'',r:[]}})} title="Pesquisar" style={{color:'#9ca3af',background:'none',border:'none',cursor:'pointer',fontSize:16,padding:'4px 8px'}} className="hover:text-white transition-colors">ğŸ”</button>
          <div style={{width:1,height:16,background:'#374151'}}/>
          <button onClick={()=>dispatchUI({t:'POMO'})} title="Pomodoro" style={{color:pomo.at?'#4ade80':'#9ca3af',background:'none',border:'none',cursor:'pointer',fontSize:14,padding:'4px 8px'}} className="transition-colors">
            ğŸ…{pomo.rod>0?` ${pomo.rod}`:''}
          </button>
          <div style={{width:1,height:16,background:'#374151'}}/>
          <button onClick={exportar} title="Exportar" style={{color:'#9ca3af',background:'none',border:'none',cursor:'pointer',fontSize:16,padding:'4px 8px'}} className="hover:text-white transition-colors">â¬‡</button>
          <label title="Importar" style={{color:'#9ca3af',cursor:'pointer',fontSize:16,padding:'4px 8px'}} className="hover:text-white transition-colors">
            â¬†<input type="file" accept=".json" onChange={importar} style={{display:'none'}}/>
          </label>
          <div style={{width:1,height:16,background:'#374151'}}/>
          <button onClick={resetar} title="Limpar todos os dados" style={{color:'#6b7280',background:'none',border:'none',cursor:'pointer',fontSize:14,padding:'4px 8px'}} className="hover:text-red-400 transition-colors">ğŸ—‘</button>
          <div style={{width:1,height:16,background:'#374151'}}/>
          <span title={syncOk===true?'Sincronizado com a nuvem':syncOk===false?'Salvo localmente (sem sync)':'Sincronizando...'} style={{fontSize:16,cursor:'default',padding:'4px 4px'}}>
            {syncOk===true?'â˜ï¸':syncOk===false?'ğŸ’¾':'ğŸ”„'}
          </span>
          <button onClick={onLogout} title="Sair da conta Google" style={{color:'#6b7280',background:'none',border:'none',cursor:'pointer',fontSize:11,padding:'4px 6px',maxWidth:80,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}} className="hover:text-blue-400 transition-colors">
            ğŸ‘¤ {userName}
          </button>
        </div>
      </div>
      <NavBar view={view} dispatchUI={dispatchUI}/>
    </div>
  );
}

// â”€â”€â”€ TELA DE LOGIN GOOGLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function LoginScreen({onLogin,loading,erro}){
  return(
    <div style={{minHeight:'100vh',background:'linear-gradient(135deg,#0f172a 0%,#1e3a5f 50%,#0f172a 100%)',display:'flex',alignItems:'center',justifyContent:'center',padding:16}}>
      <div style={{width:'100%',maxWidth:360,background:'rgba(255,255,255,0.07)',border:'1px solid rgba(255,255,255,0.15)',borderRadius:24,padding:32,textAlign:'center'}}>
        <div style={{fontSize:56,marginBottom:12}}>âš“</div>
        <h1 style={{color:'white',fontSize:22,fontWeight:'bold',margin:'0 0 8px'}}>Cronograma de Estudos</h1>
        <p style={{color:'rgba(255,255,255,0.45)',fontSize:13,margin:'0 0 32px',lineHeight:1.5}}>
          Entre com sua conta Google para sincronizar seu progresso em qualquer dispositivo
        </p>

        <button onClick={onLogin} disabled={loading}
          style={{width:'100%',padding:'14px 20px',borderRadius:14,border:'none',
            background:loading?'#374151':'white',color:loading?'#9ca3af':'#1f2937',
            fontSize:15,fontWeight:'bold',cursor:loading?'not-allowed':'pointer',
            display:'flex',alignItems:'center',justifyContent:'center',gap:10,transition:'all .2s'}}>
          {loading
            ? <><span style={{fontSize:18}}>ğŸ”„</span> Entrando...</>
            : <><svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.18 1.48-4.97 2.31-8.16 2.31-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/><path fill="none" d="M0 0h48v48H0z"/></svg>
              Entrar com Google</>
          }
        </button>

        {erro&&<p style={{color:'#f87171',fontSize:12,marginTop:14}}>{erro}</p>}

        <div style={{marginTop:24,padding:12,background:'rgba(59,130,246,0.1)',border:'1px solid rgba(59,130,246,0.2)',borderRadius:12}}>
          <p style={{color:'rgba(255,255,255,0.4)',fontSize:11,margin:0,lineHeight:1.6}}>
            ğŸ’¡ Use a mesma conta Google no PC e no celular â€” seus dados ficam sincronizados automaticamente.
          </p>
        </div>
      </div>
    </div>
  );
}

// â”€â”€â”€ AUTH WRAPPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AuthWrapper(){
  const[user,setUser]=useState(null);
  const[loading,setLoading]=useState(true);
  const[erro,setErro]=useState('');

  // onAuthStateChanged Ã© a fonte de verdade â€” detecta login/logout automaticamente
  useEffect(()=>{
    if(!window.auth){setLoading(false);return;}
    const unsub=window.auth.onAuthStateChanged(u=>{
      setUser(u||null);
      setLoading(false);
    });
    return()=>unsub();
  },[]);

  const login=()=>{
    if(!window.auth){setErro('Firebase nÃ£o disponÃ­vel.');return;}
    setErro('');
    const provider=new firebase.auth.GoogleAuthProvider();
    window.auth.signInWithPopup(provider)
      .catch(e=>{setErro('Erro ao entrar: '+e.message);});
    // setUser Ã© feito automaticamente pelo onAuthStateChanged acima
  };

  const logout=()=>{
    if(window.auth)window.auth.signOut();
    // setUser(null) Ã© feito automaticamente pelo onAuthStateChanged
  };

  if(loading)return(
    <div style={{minHeight:'100vh',background:'#0f172a',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:16}}>
      <div style={{fontSize:48}}>âš“</div>
      <div style={{color:'white',fontSize:16}}>Verificando login...</div>
      <div style={{width:40,height:40,border:'4px solid rgba(255,255,255,0.1)',borderTop:'4px solid #3b82f6',borderRadius:'50%',animation:'spin 1s linear infinite'}}/>
      <style>{`@keyframes spin{to{transform:rotate(360deg);}}`}</style>
    </div>
  );

  if(!user)return <LoginScreen onLogin={login} loading={loading} erro={erro}/>;

  const nome=user.displayName||user.email||'UsuÃ¡rio';
  return <App uid={user.uid} userName={nome} onLogout={logout}/>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<AuthWrapper/>);
</script>
</body>
</html>
